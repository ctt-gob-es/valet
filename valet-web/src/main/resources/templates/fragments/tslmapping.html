<div class="masonry-item col-md-12">
	<form name="altEditor-form" role="form" id="getIdCountryForm"
		th:object="${mappingtslform}" method="post">
		<!--  identificador idCountryRegion -->
		<input type='hidden' class='primarykey' id="idCountry"
			th:field="*{idTslCountryRegion}"></input>

		<!--  nombre del pais al que pertenece la TSL -->
		<input type='hidden' id="idNameCountry"
			th:field="*{nameCountryRegion}"></input>

		<!--  nombre del pais al que pertenece la TSL - PARA EDITAR.....-> 
	<!-- 	<input type='hidden' id="idCountryRegionMapping"
			th:field="*{idTslCountryRegionMapping}"></input> -->
	</form>
	<div class="bgc-white bd bdrs-3 p-20 mB-20">

		<h4 class="c-grey-900 mB-20"
			th:text="#{table.tsl.mapeo.title}+' '+${mappingtslform.nameCountryRegion}"></h4>

		<table id="mappingTable" class="table table-striped table-bordered"
			cellspacing="0" width="100%">
			<thead>
				<tr>
					<th></th>
					<!-- Columna oculta para el identificador de la TSL -->
					<th th:text="#{table.tsl.mapeo.id}"></th>
					<th th:text="#{table.tsl.mapeo.value}"></th>
					<th></th>

				</tr>
			</thead>
		</table>

	</div>
</div>
<!--  Modal para añadir mapeo -->
<div class="modal fade" tabindex="-1" role="dialog" id="modalAddMapping">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" th:text="#{form.newMapping.title}"></h4>
				<button type="button" class="close"
					onclick="closeModalButton('modalAddMapping', 'mappingTslForm')" aria-label="Cerrar">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form name="altEditor-form" role="form" id="mappingTslForm"
					th:object="${mappingtslform}" method="post">
					<div id="errorModalMapping" role="alert"></div>
					<input type='hidden' id="idCountryRegion"
						th:field="*{idTslCountryRegion}"></input>

					<div class="form-group col-md-12">
						<label for="idIdentificator"
							th:text="#{form.newMapping.identificator}"></label> <span
							id="mappingIdentificator_span"
							class="badge bgc-red-50 c-red-700 p-10 lh-0 tt-c badge-pill"></span><input
							type="text" id="idIdentificator" class="form-control"
							th:field="*{mappingIdentificator}" 
							onchange="cleanSpan('mappingIdentificator_span');"></input>
						<div style="clear: both;"></div>
					</div>
					<div class="form-group col-md-12">
						<label for="idValue" th:text="#{form.newMapping.value}"></label> <span
							id="mappingValue_span"
							class="badge bgc-red-50 c-red-700 p-10 lh-0 tt-c badge-pill"></span>
						<input type="text" id="idValue" class="form-control"
							th:field="*{mappingValue}"
							onchange="cleanSpan('mappingValue_span');"></input>
						<div style="clear: both;"></div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default"
					onclick="closeModalButton('modalAddMapping', 'mappingTslForm')" th:text="#{form.newMapping.btn.close}"></button>

				<button type="button" id="idNewMappingBtn" class="btn btn-primary"
					th:text="#{form.newMapping.btn.save}" onclick="saveNewMapping();"></button>
			</div>
		</div>
	</div>
</div>


<!-- Modal para editar mapeo -->
<div class="modal fade" tabindex="-1" role="dialog" id="modalEditMapping">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title">Editar Mapeo</h4>
				<button type="button" class="close"
					onclick="closeModalButton('modalEditMapping', 'mappingTslEditForm')" aria-label="Cerrar">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form name="altEditor-form" role="form" id="mappingTslEditForm"
					th:object="${mappingtslform}" method="post">

					<input type='hidden' id="idCountryRegionMappingEd"
						th:field="*{idTslCountryRegionMapping}"></input> 
					<input
						type='hidden' id="idCountryRegionEd"
						th:field="*{idTslCountryRegion}"></input>
					<div class="form-group col-md-12">
						<label for="idIdentificatorEd"
							th:text="#{form.newMapping.identificator}"></label> <input
							type="text" id="idIdentificatorEd" class="form-control"
							th:field="*{mappingIdentificator}" readonly></input>
						<div style="clear: both;"></div>
					</div>
					<div class="form-group col-md-12">
						<label for="idValueEd" th:text="#{form.newMapping.value}"></label>
						<span id="mappingValue_spanEdit"
							class="badge bgc-red-50 c-red-700 p-10 lh-0 tt-c badge-pill"></span>
						<input type="text" id="idValueEd" class="form-control"
							th:field="*{mappingValue}"
							onchange="cleanSpan('mappingValue_spanEdit');"></input>
						<div style="clear: both;"></div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default"
					onclick="closeModalButton('modalEditMapping', 'mappingTslEditForm')">Cerrar</button>

				<button type="button" id="idEditMappingBtn" class="btn btn-primary"
					th:text="Guardar" onclick="modifyMapping();"></button>
			</div>
		</div>
	</div>
</div>

<!-- Modal para eliminar un mapeo -->
<div class="modal fade" tabindex="-1" role="dialog" id="modalDeletetMapping">
   <div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h4 class="modal-title" th:text="#{form.deleteMapping.title}"></h4>
				<button type="button" class="close" data-dismiss="modal" aria-label="#{form.deleteMapping.btn.close}">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form name="altEditor-form" role="form" id="mappingTslDeleteForm" method="post" th:object="${mappingtslform}">
					
					<input type='hidden' id="idCountryRegionMappingDel"
						th:field="*{idTslCountryRegionMapping}"></input>
						
						<input type='hidden' id="rowIndexMappingDel"
						th:field="*{rowIndexMapping}"></input>
						
						<p th:text="#{form.deleteMapping.message}"></p>

				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" th:text="#{form.deleteMapping.btn.close}" onclick="closeModalButton('modalDeletetMapping', 'mappingTslDeleteForm')"></button>
				<button type="button" id="idDeleteMappingBtn" class="btn btn-primary"
					th:text="#{form.deleteMapping.btn.delete}" onclick="deleteMappingTsl();"></button>
			</div>
		</div>
	</div>
</div>

<script th:inline="javascript">
$(document).ready(function() {

	var actionOpenMapping = /*[[@{/loadmapping}]]*/;
	var addMappingTemplate = /*[[@{/addmappingtsl}]]*/;
	var idCountry = $("#idCountry").val();
	var actionSaveMapping = /*[[@{/savemappingtsl}]]*/;
	var tblMapping = $('#mappingTable').DataTable({
		dom: 'Bfrtip',
		responsive : true,
		altEditor: true,
 		buttons: [{text: 'Añadir Campo', 
		action: function(e, dt, node, config){
			
		 	$('#modalAddMapping').modal('show'); 		 
	 } }],
 			    "iTotalRecords": "totalElements",
		        "iTotalDisplayRecords": "numberOfElements",
			    
				"processing": true,
			    "serverSide": true,
				"ajax": {
			        "url": actionOpenMapping,
			        "dataSrc" : "data",
			        "data":function(data){
			            data.id = idCountry;
			           
			        }
			      },
			      "language": {
				        "url": "js/datatables/i18n/spanish.json",
				        select: {
				            rows: {
				                _: "%d filas seleccionadas",
				                1: "1 fila seleccionada"
				            }
				          }
				        },
				        "columns": [
				        	{ "data": "tslCountryRegion.idTslCountryRegion","visible": false},
					        { "data": "mappingIdentificator" },
					        { "data": "mappingValue" },
					        { "data": "idTslCountryRegionMapping", 
					        	"render": function(data, type, row){		
					        		
					        		return '<button class="c-green-500 ti-pencil-alt" id="editMappingTsl"  onclick="editMappingTsl('+data+');"></button>&nbsp;<button class="c-red-500 ti-trash" id="deleteMappingTsl"  onclick="deleteConfirmMappingTsl('+data+',this);"></button>';
					        		
					        	}
					        }
					        ]});
	
	//borra mensaje de identificador duplicado
	$("#idIdentificator").change(function(){
		//se borra mensaje de validación
		$("#errorModalMapping").removeClass('alert alert-danger');
		$("#errorModalMapping").html('');
		});
	
});

//método para cargar la tabla con los valores de mapeo del pais pasado por parámetro
function loadMappingTsl(idCountry) {
	var openMapping = /*[[@{/openmapping}]]*/;
	var idCountry = idCountry;
	$.ajax(openMapping,{
			            	data:$.param({'id':idCountry}),
			                type:'GET',
			                success: function(data){
			                	$("#tableMapping").html(data);
			                },
							error:function(data){
								alert("errorr");
							}
	
	});
}

//función cerrar modales
function closeModalButton(btnId, nameForm){
	//se limpia posibles mensajes error de span
	$('#'+nameForm+' *').filter('span').each(function(){
		cleanSpan($(this).attr('id'));
	});
	//se limpia posible mensaje error en div
		$("#errorModalMapping").removeClass('alert alert-danger');
		$("#errorModalMapping").html('');
		
	//se limpia valores del formulario
	
	 $('#idIdentificator').val("");
     $('#idValue').val("");
	$('#' + btnId).modal('hide');	
}



//método que agrega un nuevo par de identificador/valor en la tabla de mapeos
function saveNewMapping() {
	var actionSaveMapping = /*[[@{/savemappingtsl}]]*/;
	var formDataMapping = new FormData(document.forms["mappingTslForm"]);
	formDataMapping.append('idCountryRegion',idCountry);
	var tblMapping = $('#mappingTable').DataTable();
 	$.ajax(actionSaveMapping, {
		data :formDataMapping, 
		contentType: false,
		processData : false,
		type : 'POST',
		success: function(data){
				var errores = JSON.parse(data.error);
				if (data.error != null){
						 	hide();
					  jQuery.each(errores, function(i, val) {			  
						  if(i == "existIdentificator"){	
								var messageExistIden = val;
								$('#errorModalMapping').html(messageExistIden);
								$('#errorModalMapping').addClass('alert alert-danger');
						  } 						  	
						$('#mappingTslForm *').filter('span').each(function(){
						if (i == $(this).attr('id')){
								$("#" + i).text(val);
								$("#" + i).addClass('badge bgc-red-50 c-red-700 p-10 lh-0 tt-c badge-pill');
						}
						});
					  })

				  }else{
					//se oculta la capa 'cargando...'
				  	hide();
					//se añade nuevo valor
					tblMapping.row.add($(data.data)).draw(false);
				 //se cierra modal
            $('#modalAddMapping').modal('hide');
			$("#mappingTslForm")[0].reset();
}
		},
		error : function(data){
			// se oculat al capa 'cargando...'
			hide();
			//se cierra modal
            $('#modalAddMapping').modal('hide');

		}
	});
}





//método para editar mapeo
function modifyMapping() {
	var actionSaveMapping = /*[[@{/modifymappingtsl}]]*/;
	var formDataMapping = new FormData(document.forms["mappingTslEditForm"]);
	
	var tblMapping = $('#mappingTable').DataTable();
 	$.ajax(actionSaveMapping, {
		data :formDataMapping, 
		contentType: false,
		processData : false,
		type : 'POST',
		success: function(data){
			var errores = JSON.parse(data.error);
			if (data.error != null){
					 	hide();
				  jQuery.each(errores, function(i, val) {		  	
				$('#mappingTslEditForm *').filter('span').each(function(){
								if (i == $(this).attr('id')){
									$("#" + i).text(val);
									$("#" + i).addClass('badge bgc-red-50 c-red-700 p-10 lh-0 tt-c badge-pill');
								}
							});
				  })

			  }else{
//se oculta la capa 'cargando...'
			  	hide();
//se añade nuevo valor
			 tblMapping.row.add($(data.data)).draw(false);
			 //se cierra modal
        $('#modalEditMapping').modal('hide');
		$("#mappingTslEditForm")[0].reset();
}
	},
	error : function(data){
		// se oculat al capa 'cargando...'
		hide();
		//se cierra modal
        $('#modalEditMapping').modal('hide');

	}
	});
}





//Función para cargar los datos del par identificador/valor seleccionado.
function editMappingTsl(idTslCountryRegionMapping) {
	var loadMapping = /*[[@{/loadmappingbyid}]]*/
	var idCRM= idTslCountryRegionMapping;
	$.ajax(loadMapping,{
		data:$.param({'idTslCountryRegionMapping':idCRM}),
        type:'GET',
        success: function(data){
    		// Se oculta la capa 'cargando...'
    		hide();
    		 $('#modalEditMapping').modal('show');
    		 $('#idCountryRegionEd').val(data.idTslCountryRegion);
    		 $('#idCountryRegionMappingEd').val(data.idTslCountryRegionMapping);
    		 $('#idIdentificatorEd').val(data.mappingIdentificator);
    		 $('#idValueEd').val(data.mappingValue);
        },
        error:function(data){
        	// Se oculta la capa 'cargando...'
        	hide();
        	// Se eliminan los posibles errores anteriores...
        	//cleanValidationResult('tslFormEdit');
        	alert("error");
        
}
	});
}

//Función mostrar el modal de confirmación antes de  eliminar un mapeo
function deleteConfirmMappingTsl(idTslCountryRegionMapping,  element) {
	var loadConfirmDelete = /*[[@{/loadconfirmdelete}]]*/
	var idCRM= idTslCountryRegionMapping;
	var rowIndex = element.parentNode.parentNode.rowIndex;
	$.ajax(loadConfirmDelete,{
			data:$.param({'idTslCountryRegionMapping':idCRM, 'rowindex':rowIndex}),
	        type:'GET',
	        success: function(data){
	    		// Se oculta la capa 'cargando...'
	    		hide();
	    		 $('#modalDeletetMapping').modal('show');
	    		 $('#idCountryRegionMappingDel').val(data.idTslCountryRegionMapping);
	    		 $('#rowIndexMappingDel').val(data.rowIndexMapping);
	        },
	        error:function(data){
	        	// Se oculta la capa 'cargando...'
	        	hide();
	        	// Se eliminan los posibles errores anteriores...
	        	//cleanValidationResult('tslFormEdit');
	        	alert("error");
	        
	}
		});
}


//borrar el par identificador/valor seleccionado
function deleteMappingTsl(){
	var formDataMapping = new FormData(document.forms["mappingTslDeleteForm"]);	
	var deleteMapping = /*[[@{/deletemappingbyid}]]*/;
	var tblMapping = $('#mappingTable').DataTable();
	$.ajax(deleteMapping,{
		data:formDataMapping,
		type:'POST',
		contentType: false,
		processData : false,
		success: function(data){
		//Se oculta la capa 'cargando...'
		hide();
		closeModalButton('modalDeletetMapping', 'mappingTslDeleteForm');
    	tblMapping.row(data.index).remove().draw();
		},
		error:function(){
			alert("error al eliminar");
		}
		});
}

</script>