<div class="container-fluid" id="tableTsl">
	<h4 class="c-grey-900 mT-10 mB-30" th:text="#{tsl.admin.title}"></h4>
	<div class="row">
		<div class="col-md-12">
			<div class="bgc-white bd bdrs-3 p-20 mB-20">
				<h4 class="c-grey-900 mB-20" th:text="#{table.tsl.title}"></h4>
				<table id="tslTable" class="table table-striped table-bordered"
					cellspacing="0" width="100%">
					<thead>
						<tr>
							<!-- Columna oculta para el identificador de la TSL -->
							<th></th>
							<th></th>
							<th th:text="#{table.tsl.country}"></th>
							<th th:text="#{table.tsl.sequence}"></th>
							<th th:text="#{table.tsl.issueDate}"></th>
							<th th:text="#{table.tsl.expirationDate}"></th>
							
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>
<script th:inline="javascript">
$(document).ready(function() {
var getTsls =/*[[@{/tsldatatable}]]*/;
var addTemplate = /*[[@{/addTsl}]]*/;
var editTemplate = /*[[@{/edittsl}]]*/;
var actionSave = /*[[@{/savetsl}]]*/;
var actionUpdate = /*[[@{/updatetsl}]]*/;
var actionDelete = /*[[@{/deletetsl}]]*/;

var tbl = $('#tslTable').DataTable({
	dom: 'Bfrtip',
	select: 'single',
	responsive : true,
	altEditor: true,
	  buttons: [{text: 'Agregar',name: 'add'}, 
		  {extend: 'selected',text: 'Editar',name: 'edit'}, 
		  {extend: 'selected',text: 'Eliminar',name: 'delete'}],
	  "iTotalRecords": "totalElements",
      "iTotalDisplayRecords": "numberOfElements",
  	"processing": true,
    "serverSide": true,
	"ajax": {
        "url": getTsls,
        "dataSrc" : "data",
        "data": function (data) {
        	// Datos a pasar al modal
            data.formId = "tslForm";
            data.editTemplate = editTemplate;
            data.addTemplate = addTemplate;
        }
      },
      "language": {
        "url": "js/datatables/i18n/spanish.json",
        select: {
            rows: {
                _: "%d filas seleccionadas",
                1: "1 fila seleccionada"
            }
          }
        },
	"columns": [
        { "data": "idTslValet","visible": false},
        { "data": "country.idTSLCountryRegion", "visible":false},
        { "data": "country.countryRegionName"},
        { "data": "sequenceNumber"},
        { "data": "issueDate"},
        { "data": "expirationDate"}
        ]
}).on('crudaction', function(e, accion, idTslValet, data, rowindex) {
	// e          Evento Jquery
    // accion     [add|edit|delete]
    // pkid       Primer campo en la data [id]                ... en add,    retorna null
    // data       Los campos adicionales  [campo_1, campo_n]  ... en delete, retorna null
    // rowindex   El index de la fila para el dataTable       ... en add,    retorna null
	 $('#altEditor-modal .modal-body .alert').remove();
	    // Se muestra la capa 'cargando...'
	    loading();
	    
	    switch(accion){
	        case 'add':
	        	var formData = new FormData(document.forms["tslForm"]);
	        	$.ajax(actionSave, {
	        		data :formData,
	        		contentType: false,
	        		processData : false,
	        		type : 'POST',
	        		success: function(data){
	        			//se oculta la capa 'cargando...'
	        			hide();
	        			tbl.row.add($(data.data)).draw(false);
	        			$('#altEditor-modal .modal-body .alert').remove();
	                    $('#altEditor-modal').modal('hide');
	        		},
	        		error : function(data){
	        			// se oculat al capa 'cargando...'
	        			hide();
	        			// se eliminan los posibles errores anteriores
	        			cleanValidationResult('tslForm');
	        			// se obtiene el JSON de los campos con errores de validación y se modifican los estilos y se añaden mensajes
	        			var validation = $(data)["0"].responseJSON;
			            drawValidationResult(validation.fieldErrors);
	        		}
	        	});
	            break;
	        case 'edit':
	        	var formDataEdit = new FormData(document.forms["tslFormEdit"]);
	        	$.ajax(actionUpdate, {
	        		data :formDataEdit,
	        		contentType: false,
	        		processData : false,
	                type:'POST',
	                success: function(data){
	                  debugger;
	            		// Se oculta la capa 'cargando...'
	            		hide();
	                    tbl.row.add($(data.data)).draw(false);
	                    		                    
	                    $('#altEditor-modal .modal-body .alert').remove();
	                    $('#altEditor-modal').modal('hide');
	                    		                    
	                },
	                error:function(data){
	                	debugger;
	                	// Se oculta la capa 'cargando...'
	                	hide();
	                	// Se eliminan los posibles errores anteriores...
	                	cleanValidationResult('tslForm');
	                	// Se obtiene el JSON de los campos con errores de validaciÃ³n
	                	// y se modifican los estilos/aÃ±aden mensajes
	                	var validation = $(data)["0"].responseJSON;
	                	drawValidationResult(validation.fieldErrors);
	              
	                }
	            });
       
        	$('#tslForm').addClass('was-validated');
         	break;
	        case 'delete':
	       break;
	    }
});
});
</script>

